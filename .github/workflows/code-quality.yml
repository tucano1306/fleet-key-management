name: Code Quality

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

    - name: Check for vulnerable dependencies
      run: |
        echo "ğŸ”’ Checking for security vulnerabilities..."
        npm audit || echo "âš ï¸ Some vulnerabilities found - review recommended"

    - name: Generate audit report
      if: always()
      run: |
        npm audit --json > audit-report.json || true
        echo "ğŸ“Š Audit report generated"

    - name: Upload audit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: audit-report.json
        retention-days: 30

  dependency-check:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check for outdated dependencies
      run: |
        echo "ğŸ“¦ Checking for outdated dependencies..."
        npm outdated || true

    - name: Analyze dependency tree
      run: |
        echo "ğŸŒ³ Dependency tree analysis:"
        npm list --depth=1 || true

    - name: Check bundle size
      run: |
        echo "ğŸ“ Estimating bundle size..."
        npm run build
      env:
        DATABASE_URL: postgresql://user:password@localhost:5432/test?schema=public
        NEXTAUTH_SECRET: test-secret
        NEXTAUTH_URL: http://localhost:3000
      continue-on-error: true

  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint
      continue-on-error: true

    - name: Type check
      run: npx tsc --noEmit

    - name: Generate Prisma Client
      run: npx prisma generate
      env:
        DATABASE_URL: postgresql://user:password@localhost:5432/test?schema=public

    - name: Validate Prisma schema
      run: npx prisma validate

    - name: Check for TODO/FIXME comments
      run: |
        echo "ğŸ” Searching for TODO/FIXME comments..."
        grep -r "TODO\|FIXME" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . || echo "No TODO/FIXME found"
      continue-on-error: true

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build for production
      run: npm run build
      env:
        DATABASE_URL: postgresql://user:password@localhost:5432/test?schema=public
        NEXTAUTH_SECRET: test-secret
        NEXTAUTH_URL: http://localhost:3000

    - name: Analyze bundle
      run: |
        echo "ğŸ“Š Analyzing Next.js build output..."
        ls -lh .next/static/chunks/*.js 2>/dev/null || echo "Chunks not found"
        du -sh .next 2>/dev/null || echo "Build directory not found"
      continue-on-error: true

  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [security-audit, dependency-check, code-analysis, performance-check]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Code Quality Check Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”’ Security Audit: ${{ needs.security-audit.result }}"
        echo "ğŸ“¦ Dependency Check: ${{ needs.dependency-check.result }}"
        echo "ğŸ” Code Analysis: ${{ needs.code-analysis.result }}"
        echo "âš¡ Performance Check: ${{ needs.performance-check.result }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
