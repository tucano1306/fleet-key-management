name: Post-Deploy Database Migrations

on:
  workflow_run:
    workflows: ["Deploy to Vercel"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      run_seed:
        description: 'Run database seed after migrations'
        required: false
        default: 'false'
        type: boolean

jobs:
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Vercel CLI
      run: npm install --global vercel@latest

    - name: Pull Vercel Environment
      run: vercel env pull .env.production --yes --token=${{ secrets.VERCEL_TOKEN }}
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    - name: Generate Prisma Client
      run: npx prisma generate

    - name: Check pending migrations
      id: check_migrations
      run: |
        echo "ğŸ” Checking for pending migrations..."
        PENDING=$(npx prisma migrate status 2>&1 | grep -c "pending" || echo "0")
        echo "pending_count=$PENDING" >> $GITHUB_OUTPUT
        if [ "$PENDING" -gt 0 ]; then
          echo "âš ï¸ Found $PENDING pending migration(s)"
        else
          echo "âœ… No pending migrations"
        fi
      continue-on-error: true

    - name: Run migrations
      if: steps.check_migrations.outputs.pending_count > 0 || github.event_name == 'workflow_dispatch'
      run: |
        echo "ğŸ”„ Running database migrations..."
        npx prisma migrate deploy
        echo "âœ… Migrations completed successfully"

    - name: Run database seed
      if: github.event.inputs.run_seed == 'true'
      run: |
        echo "ğŸŒ± Seeding database..."
        npx tsx prisma/seed.ts
        echo "âœ… Database seeded successfully"

    - name: Verify database status
      run: |
        echo "ğŸ“Š Verifying database status..."
        npx prisma migrate status
      continue-on-error: true

    - name: Migration Summary
      if: always()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ—„ï¸ Database Migration Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ Workflow: ${{ github.workflow }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ“¦ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ Database Migration Failed',
            body: `## Database Migration Failed
            
            **Workflow**: ${context.workflow}
            **Branch**: ${context.ref}
            **Commit**: ${context.sha}
            **Actor**: ${context.actor}
            **Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            Please check the logs and run migrations manually if needed:
            \`\`\`bash
            vercel env pull .env.production
            npx prisma migrate deploy
            \`\`\`
            
            ---
            *This issue was automatically created by GitHub Actions*
            `,
            labels: ['bug', 'database', 'urgent']
          })
