name: Vercel Preview Comment

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  comment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for Vercel deployment
      uses: patrickedqvist/wait-for-vercel-preview@v1.3.1
      id: waitForDeployment
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        max_timeout: 300
        check_interval: 10

    - name: Comment on PR with deployment info
      if: steps.waitForDeployment.outputs.url != ''
      uses: actions/github-script@v7
      with:
        script: |
          const deploymentUrl = '${{ steps.waitForDeployment.outputs.url }}';
          const prNumber = context.issue.number;
          const sha = context.sha.substring(0, 7);
          
          const body = `
          ## ðŸš€ Vercel Deployment Ready!
          
          | Name | Value |
          |------|-------|
          | **Preview URL** | [${deploymentUrl}](${deploymentUrl}) |
          | **Commit** | \`${sha}\` |
          | **Branch** | \`${context.ref}\` |
          | **Author** | @${context.actor} |
          
          ### ðŸ“ Quick Links
          - ðŸ” [Login Page](${deploymentUrl}/login)
          - ðŸ“Š [Dashboard](${deploymentUrl}/dashboard)
          - âš¡ [Quick Checkout](${deploymentUrl}/dashboard/quick-checkout)
          
          ### ðŸ§ª Test Credentials
          **DISPATCH (Admin):**
          - ID: \`0000\`
          - PIN: \`0000\`
          
          **DRIVER (Chofer):**
          - Last 4: \`5678\`
          - PIN: \`1234\`
          
          ---
          *Deployment powered by [Vercel](https://vercel.com)*
          `;
          
          // Check if comment already exists
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Vercel Deployment Ready')
          );
          
          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
          }
